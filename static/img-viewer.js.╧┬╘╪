define("imgZoom",["zepto"],function($){"use strict";var Zoom=function(container,options){this.container=container;this.el=container.children();this.zoom_factor=1;this.last_scale=1;this.offset={x:0,y:0};this.origin_width=this.el[0].offsetWidth;this.origin_Height=this.el[0].offsetHeight;this.is_first_update_flag=true;this.options=$.extend({},this.default,options);this.compatible_for_android();this.bind_events();this.update();this.enable()};Zoom.prototype={default:{doubletap_zoom_factor:2,zoom_out_factor:1.2,animation_time:300,lock_drag_axis:false,max_zoom:4,min_zoom:.5,use_2d:true,double_tap_event:"double_tap",zoom_start_event:"zoom_start",zoom_end_event:"zoom_end",drag_start_event:"drag_start",drag_end_event:"drag_end",long_image_drag_event:"long_image_drag"},compatible_for_android:function(){window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/30)}}()},bind_events:function(){detect_events(this.container.get(0),this);$(window).on("resize",this.update.bind(this));$(this.el).find("img").on("load",this.update.bind(this))},update:function(){if(this.update_lock){return}this.update_lock=true;setTimeout(function(){this.update_lock=false;this.update_aspect_ratio();var zoom_factor=this.get_initial_zoom_factor()*this.zoom_factor,zoom_factor_y=this.get_initial_zoom_factor_y()*this.zoom_factor,offset_x=-this.offset.x/zoom_factor,offset_y=-this.offset.y/zoom_factor_y;if(this.el[0].offsetWidth<window.innerWidth){offset_x=0;offset_y=0}var transform3d="scale3d("+zoom_factor+","+zoom_factor+",1) "+"translate3d("+offset_x+"px,"+offset_y+"px,0px)",transform2d="scale("+zoom_factor+","+zoom_factor+") "+"translate("+offset_x+"px,"+offset_y+"px)",remove_clone=function(){if(this.clone){this.clone.remove();delete this.clone}}.bind(this);if(!this.options.use_2d|this.has_interaction|this.in_animation){this.use_3d=true;remove_clone();this.el.css({"-webkit-transform":transform3d,"-o-transform":transform2d,"-ms-transform":transform2d,"-moz-transform":transform2d,transform:transform3d})}else{if(this.use_3d){this.clone=this.el.clone();this.clone.css("pointer-events","none");this.clone.appendTo(this.container);setTimeout(remove_clone,200)}if(!this.is_first_update_flag){this.el.css({"-webkit-transform":transform2d,"-o-transform":transform2d,"-ms-transform":transform2d,"-moz-transform":transform2d,transform:transform2d})}this.use_3d=false}if(this.el[0].offsetWidth<window.innerWidth){var w=this.el[0].offsetWidth*zoom_factor,h=this.el[0].offsetHeight*zoom_factor,offset_top=(window.innerHeight-h)/2,offset_left=(window.innerWidth-w)/2;this.container.css({width:w,height:h,"margin-top":offset_top+"px","margin-left":offset_left+"px","margin-bottom":offset_top+"px","margin-right":offset_left+"px"})}if(this.is_first_update_flag){this.small_image_auto_fit()}}.bind(this),0)},small_image_auto_fit:function(){if(this.el[0].offsetWidth<window.innerWidth){this.el.css({width:this.origin_width,height:this.origin_Height})}this.is_first_update_flag=false},enable:function(){this.enabled=true},disable:function(){this.enabled=false},sum:function(x,y){return x+y},add_offset:function(offset){this.offset={x:this.offset.x+offset.x,y:this.offset.y+offset.y}},get_touches:function(event){var position=this.container.offset();return Array.prototype.slice.call(event.touches).map(function(touch){return{x:touch.pageX-position.left,y:touch.pageY-position.top}})},handle_double_tap:function(event){var center=this.get_touches(event)[0],zoom_factor=this.zoom_factor>1?1:this.options.doubletap_zoom_factor,start_factor=this.zoom_factor,update_progress=function(progress){this.scale_to(start_factor+progress*(zoom_factor-start_factor),center)}.bind(this);if(this.has_interaction){return}if(start_factor>zoom_factor){center=this.get_current_center()}if(this.el[0].offsetHeight>window.innerHeight&&zoom_factor==1){var normal_offset=this.sanitize_offset(this.offset);center=normal_offset}this.animate(this.options.animation_time,update_progress,this.swing);this.el.trigger(this.options.double_tap_event)},scale_to:function(zoom_factor,center){this.scale(zoom_factor/this.zoom_factor,center)},scale:function(scale,center){scale=this.scale_zoom_factor(scale);this.add_offset({x:(scale-1)*(center.x+this.offset.x),y:(scale-1)*(center.y+this.offset.y)})},scale_zoom_factor:function(scale){var origin_zoom_factor=this.zoom_factor;this.zoom_factor*=scale;this.zoom_factor=Math.min(this.options.max_zoom,Math.max(this.zoom_factor,this.options.min_zoom));return this.zoom_factor/origin_zoom_factor},get_current_center:function(){var container_width=this.container[0].offsetWidth,length=container_width*this.zoom_factor,offset_left=this.offset.x,offset_right=length-offset_left-container_width,width_offset_ratio=offset_left/offset_right,center_x=width_offset_ratio*container_width/(width_offset_ratio+1);var container_height=this.container[0].offsetHeight,height=container_height*this.zoom_factor,offset_top=this.offset.y,offset_bottom=height-offset_top-container_height,height_offset_ratio=offset_top/offset_bottom,center_y=height_offset_ratio*container_height/(height_offset_ratio+1);if(offset_right===0){center_x=container_width}if(offset_bottom===0){center_y=container_height}if(this.el[0].offsetHeight>window.innerHeight){center_y=this.offset.y}return{x:center_x,y:center_y}},swing:function(progress){return-Math.cos(progress*Math.PI)/2+.5},animate:function(period,get_frame,timefn,callback){var start_time=(new Date).getTime(),render_frame=function(){if(!this.in_animation){return}var execute_time=(new Date).getTime()-start_time,progress=execute_time/period;if(progress>=1){get_frame(1);if(callback){callback()}this.update();this.stop_animate();this.update()}else{if(timefn){progress=timefn(progress)}get_frame(progress);this.update();requestAnimationFrame(render_frame)}}.bind(this);this.in_animation=true;requestAnimationFrame(render_frame)},stop_animate:function(){this.in_animation=false},handle_drag_start:function(event){if(!(this.el[0].offsetHeight>window.innerHeight&&this.zoom_factor==1)){this.el.trigger(this.options.drag_start_event)}this.stop_animate();this.last_position=false;this.has_interaction=true;this.handle_drag(event)},handle_drag:function(event){if(this.zoom_factor>1){var touch=this.get_touches(event)[0];this.drag(touch,this.last_position);if(this.el[0].offsetHeight<window.innerHeight){this.offset=this.sanitize_offset(this.offset)}this.last_position=touch}else{if(this.el[0].offsetHeight>window.innerHeight&&this.zoom_factor==1){var touch=this.get_touches(event)[0];this.drag(touch,this.last_position);this.offset=this.sanitize_offset_for_long_image(this.offset);this.old_last_position=this.last_position;this.last_position=touch}}},handle_drag_end:function(){this.el.trigger(this.options.drag_end_event);this.end()},handle_zoom_start:function(event){this.el.trigger(this.options.zoom_start_event);this.stop_animate();this.last_scale=1;this.last_center=false;this.has_interaction=true;this.zoom_times=0},handle_zoom:function(event,newscale){var zoom_center=this.get_zoom_center(this.get_touches(event)),scale=newscale/this.last_scale;this.last_scale=newscale;this.zoom_times+=1;if(this.zoom_times>3){this.scale(scale,zoom_center);this.drag(zoom_center,this.last_center)}this.last_center=zoom_center},handle_zoom_end:function(event){this.el.trigger(this.options.zoom_end_event);this.end()},get_zoom_center:function(touches){return{x:touches.map(function(touch){return touch.x}).reduce(this.sum)/touches.length,y:touches.map(function(touch){return touch.y}).reduce(this.sum)/touches.length}},drag:function(center,last_center){if(last_center){if(this.lock_drag_axis){if(Math.abs(center.x-last_center.x)>Math.abs(center.y-last_center.y)){this.add_offset({x:-(center.x-last_center.x),y:0})}else{this.add_offset({x:0,y:-(center.y-last_center.y)})}}else{this.add_offset({x:-(center.x-last_center.x),y:-(center.y-last_center.y)})}}},end:function(){this.has_interaction=false;this.sanitize();this.update()},sanitize_offset_for_long_image:function(offset){var max_x=(this.zoom_factor-1)*this.get_container_x(),max_offset_x=Math.max(max_x,0),min_offset_x=Math.min(max_x,0);return{x:Math.min(Math.max(offset.x,min_offset_x),max_offset_x),y:offset.y}},sanitize_offset:function(offset){var max_x=(this.zoom_factor-1)*this.get_container_x(),max_offset_x=Math.max(max_x,0),min_offset_x=Math.min(max_x,0);var max_y,min_offset_y,max_offset_y;if(this.el[0].offsetHeight>window.innerHeight){max_y=(this.zoom_factor-1)*(this.get_container_x()/this.get_aspect_ratio())+this.get_container_x()*(1/this.get_aspect_ratio()-1/this.get_outer_aspect_ratio())}else{max_y=(this.zoom_factor-1)*(this.get_container_x()/this.get_outer_aspect_ratio())}min_offset_y=Math.min(max_y,0);max_offset_y=Math.max(max_y,0);if(this.el[0].offsetHeight>window.innerHeight){return{x:Math.min(Math.max(offset.x,0),max_offset_x),y:Math.min(Math.max(offset.y,min_offset_y),max_offset_y)}}return{x:Math.min(Math.max(offset.x,min_offset_x),max_offset_x),y:Math.min(Math.max(offset.y,min_offset_y),max_offset_y)}},sanitize:function(){if(this.zoom_factor<this.options.zoom_out_factor&&this.zoom_factor!=1){this.zoom_out_animation()}else if(this.is_abnormal_offset(this.offset)){this.sanitize_offset_animation()}},zoom_out_animation:function(){var target_zoom_factor=1,start_zoom_factor=this.zoom_factor,center=this.get_current_center(),update_progress=function(progress){this.scale_to(start_zoom_factor+progress*(target_zoom_factor-start_zoom_factor),center)}.bind(this);this.animate(this.options.animation_time,update_progress,this.swing);if(this.el[0].offsetHeight>window.innerHeight){this.sanitize_offset_animation()}},is_abnormal_offset:function(offset){var normal_offset=this.sanitize_offset(offset);return normal_offset.x!==offset.x||normal_offset.y!==offset.y},sanitize_offset_animation:function(){var normal_offset=this.sanitize_offset(this.offset),start_offset={x:this.offset.x,y:this.offset.y};var update_progress=function(progress){this.offset.x=start_offset.x+progress*(normal_offset.x-start_offset.x);this.offset.y=start_offset.y+progress*(normal_offset.y-start_offset.y);this.update()}.bind(this);this.animate(this.options.animation_time,update_progress,this.swing)},get_container_x:function(){return this.container[0].offsetWidth},get_container_y:function(){return this.container[0].offsetHeight},set_container_y:function(y){return this.container.height(y)},get_aspect_ratio:function(){return this.el[0].offsetWidth/this.el[0].offsetHeight},get_outer_aspect_ratio:function(){if(this.el[0].offsetWidth<window.innerWidth){return this.el[0].offsetWidth/this.el[0].offsetHeight}else{return this.el.parents(".image-viewer")[0].offsetWidth/this.el.parents(".image-viewer")[0].offsetHeight}},update_aspect_ratio:function(){if(this.el[0].offsetHeight>window.innerHeight){this.set_container_y(this.get_container_x()/this.get_aspect_ratio())}else{this.set_container_y(this.get_container_x()/this.get_outer_aspect_ratio())}},get_initial_zoom_factor:function(){if(this.el[0].offsetWidth<window.innerWidth){return 1}else{return this.container[0].offsetWidth/this.el[0].offsetWidth}},get_initial_zoom_factor_y:function(){if(this.el[0].offsetWidth<window.innerWidth){return 1}else{return this.container[0].offsetHeight/this.el[0].offsetHeight}},can_drag:function(){return!this.is_close_to(this.zoom_factor,1)},is_close_to:function(arg,target){return arg>target-.01&&arg<target+.01}};var detect_events=function(el,target){var interaction=null,start_touches=null,fingers=null,last_touch_start_time=null,is_odd_move1=true,is_odd_move2=true,set_interaction=function(new_interaction,event){if(interaction!==new_interaction){if(interaction&&!new_interaction){switch(interaction){case"zoom":target.handle_zoom_end(event);break;case"drag":target.handle_drag_end(event);break}}switch(new_interaction){case"zoom":target.handle_zoom_start(event);break;case"drag":target.handle_drag_start(event);break}}interaction=new_interaction},update_interaction=function(event){if(fingers===2){set_interaction("zoom",event)}else if(fingers===1){if(target.can_drag()){set_interaction("drag",event)}else{if(target.el[0].offsetHeight>window.innerHeight){set_interaction("drag",event)}else{set_interaction(null,event)}}}else{set_interaction(null,event)}},target_touches=function(touches){return Array.prototype.slice.call(touches).map(function(touch){return{x:touch.pageX,y:touch.pageY}})},get_distance=function(a,b){var x,y;x=a.x-b.x;y=a.y-b.y;return Math.sqrt(x*x+y*y)},calculate_scale=function(start_touches,current_touches){var start_distance=get_distance(start_touches[0],start_touches[1]),current_distance=get_distance(current_touches[0],current_touches[1]);return current_distance/start_distance},cancel_events=function(event){event.stopPropagation();event.preventDefault()},detect_double_tap=function(event){var current_time=(new Date).getTime();if(fingers>1){last_touch_start_time=null}if(current_time-last_touch_start_time<300){target.handle_double_tap(event);switch(interaction){case"zoom":target.handle_zoom_end(event);break;case"drag":target.handle_drag_end(event);break}}if(fingers==1){last_touch_start_time=current_time}},first_move=true,is_first_long_image_drag=true;el.addEventListener("touchstart",function(event){if(target.enabled){first_move=true;is_first_long_image_drag=true;fingers=event.touches.length;detect_double_tap(event)}});el.addEventListener("touchmove",function(event){if(target.enabled){if(first_move){update_interaction(event);if(interaction){if(!(target.el[0].offsetHeight>window.innerHeight)){cancel_events(event)}}start_touches=target_touches(event.touches)}else{switch(interaction){case"zoom":target.handle_zoom(event,calculate_scale(start_touches,target_touches(event.touches)));break;case"drag":target.handle_drag(event);break}if(interaction){if(target.el[0].offsetHeight>window.innerHeight&&target.is_close_to(target.zoom_factor,1)){if(target.old_last_position&&Math.abs(event.touches[0].clientX-target.old_last_position.x)<Math.abs(event.touches[0].clientY-target.old_last_position.y)){cancel_events(event);if(is_odd_move1){target.update();is_odd_move1=false}else{is_odd_move1=true}if(is_first_long_image_drag){target.el.trigger(target.options.long_image_drag_event);is_first_long_image_drag=false}}}else{cancel_events(event);if(is_odd_move2){target.update();is_odd_move2=false}else{is_odd_move2=true}}}}first_move=false}});el.addEventListener("touchend",function(event){if(target.enabled){fingers=event.touches.length;update_interaction(event);is_odd_move1=true;is_odd_move2=true}})};return Zoom});define(["zepto","imgZoom"],function($,imgZoom){function viewer(area){area.append("<div id='image-viewer' class='image-viewer'><div class='view' style='height: 100%; width: 100%;'></div><div class='paging'></div></div>");var that={all:[],index:0},img_all=area.find(".mod-html img, .mod-pic img, .mod-picgroup img");$el=area.find("#image-viewer"),$contentEl=$el.find(".view"),$paging=$el.find(".paging"),current="",windowResizeHandler=null;img_all.each(function(i,o){var url=$(o).attr("src").split("/imageView")[0];that.all.push(url)});area.on("click",".mod-html, .mod-pic, .mod-picgroup",function(ev){if(ev.target.tagName!=="IMG"){return}var parent_a=$(ev.target).parent("a");if(parent_a.length>0&&parent_a.attr("href")!="javascript:;"){return}current=$(ev.target).attr("src").split("/imageView")[0];for(var i in that.all){if(current==that.all[i]){that.index=parseInt(i)}}show();bindEvents()});function bindEvents(){that.is_double_touch=false;that.is_long_image_drag=false;$el.on("touchstart",function(ev){if(ev.touches.length==1){that.touch_start=$.extend({},ev.touches[0]);that.is_double_touch=false;that.is_long_image_drag=false}else{that.is_double_touch=true;ev.stopPropagation();ev.preventDefault()}if(that.is_drag){ev.stopPropagation();ev.preventDefault()}if(that.is_double_touch){ev.stopPropagation();ev.preventDefault()}});setTimeout(function(){$el.on("singleTap",function(ev){ev.stopPropagation();ev.preventDefault();if($contentEl.find("img")[0].offsetHeight>window.innerHeight){if(!that.touch_end&&!that.is_drag&&!that.is_double_touch&!that.is_long_image_drag){if(that.single_lock1)return;that.single_lock1=true;setTimeout(function(){that.single_lock1=false;close()},320)}}else{if(!that.touch_end&&!that.is_drag&&!that.is_double_touch){if(that.single_lock1)return;that.single_lock1=true;setTimeout(function(){that.single_lock1=false;close()},320)}}})},420);$el.on("doubleTap",function(ev){ev.stopPropagation();ev.preventDefault()});$el.on("touchmove",function(ev){if(ev.touches.length==1){that.touch_end=ev.touches[0];that.is_double_touch=false}else{that.is_double_touch=true}ev.stopPropagation();ev.preventDefault()});$el.on("drag_start",function(ev){that.is_drag=true});$el.on("zoom_start",function(){that.is_double_touch=true});$el.on("long_image_drag",function(){that.is_long_image_drag=true});$el.on("touchend",function(ev){if(that.is_double_touch){ev.stopPropagation();ev.preventDefault();that.touch_end=null;that.touch_start=null;that.is_drag=false;return}if(that.is_drag){ev.stopPropagation();ev.preventDefault()}if(!that.is_drag&&$contentEl.find("img")[0].offsetHeight>window.innerHeight){if(that.touch_start&&that.touch_end){if(that.touch_start.clientY-that.touch_end.clientY>40||that.touch_start.clientY-that.touch_end.clientY<-40){that.is_drag=true}}}var touch_end=that.touch_end;if(that.touch_start&&that.touch_end&&!that.is_drag){if(that.touch_start.clientX-touch_end.clientX>40){ev.stopPropagation();ev.preventDefault();next()}else if(that.touch_start.clientX-touch_end.clientX<-40){ev.stopPropagation();ev.preventDefault();prev()}}if(that.touch_start&&that.touch_end){if(that.touch_start.clientY-that.touch_end.clientY>1||that.touch_start.clientY-that.touch_end.clientY<-1){ev.stopPropagation();ev.preventDefault()}}that.touch_end=null;that.touch_start=null;that.is_drag=false})}function next(){if(that.index<that.all.length-1){that.index++;displayImage()}}function prev(){if(that.index>0){that.index--;displayImage()}}function show(){$("body").addClass("no-scroll");displayImage();$el.show();windowResizeHandler=function(){displayImage()};$(window).resize(windowResizeHandler)}function close(){if(windowResizeHandler){$(window).unbind("resize",windowResizeHandler)}$el.find("img").removeAttr("style");$("body").removeClass("no-scroll");$contentEl.html("");$paging.html("");$el.unbind("touchstart");$el.unbind("touchend");$el.unbind("touchmove");$el.unbind("singleTap");$el.hide()}function displayImage(){var current=that.all[that.index];if(!current){return}$paging.html("<span style='vertical-align:50%;height:14px;'> "+(that.index+1)+" / "+that.all.length+"</span>");var img=new Image;$contentEl.find(".zoom_container").hide();SOHUZ.ui.loader.show();img.onload=function(){$contentEl.html("<div class='zoom_container'><img src='"+current+"'></div>");var container=$contentEl.find(".zoom_container"),el=container.children();container.css({overflow:"hidden",position:"relative"});el.css({"-webkit-transform-origin":"0% 0%","-moz-transform-origin":"0% 0%","-ms-transform-origin":"0% 0%","-o-transform-origin":"0% 0%","transform-origin":"0% 0%",position:"absolute"});var w=img.width,h=img.height,s_w=window.innerWidth,s_h=window.innerHeight,scale=w/s_w,display_w=scale<1?w:s_w,display_h=scale<1?h:h/scale,offset_top=display_h>s_h?0:(s_h-display_h)/2,offset_left=display_w>s_w?0:(s_w-display_w)/2;if(scale<1){el.css({width:display_w,height:display_h});container.css({width:display_w,height:display_h,"margin-top":offset_top+"px","margin-left":offset_left+"px","margin-bottom":offset_top+"px","margin-right":offset_left+"px"})}else{el.css({width:display_w,height:display_h,"margin-top":offset_top+"px","margin-left":offset_left+"px","margin-bottom":offset_top+"px","margin-right":offset_left+"px"});container.css({width:display_w,height:display_h})}SOHUZ.ui.loader.hide();container.show();var zoom=new imgZoom(container,{})};img.onerror=function(){$contentEl.html("<span>图片加载失败</span>")};img.src=current}}return viewer});